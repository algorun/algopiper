<script type="text/javascript">
    var singleComment = 1;
    var multiComment = 2;   

	function stripJsonComments(str) {
		var currentChar;
		var nextChar;
		var insideString = false;
		var insideComment = false;
		var ret = '';

		for (var i = 0; i < str.length; i++) {
			currentChar = str[i];
			nextChar = str[i + 1];

			if (!insideComment && currentChar === '"') {
				var escaped = str[i - 1] === '\\' && str[i - 2] !== '\\';
				if (!insideComment && !escaped && currentChar === '"') {
					insideString = !insideString;
				}
			}

			if (insideString) {
				ret += currentChar;
				continue;
			}

			if (!insideComment && currentChar + nextChar === '//') {
				insideComment = singleComment;
				i++;
			} else if (insideComment === singleComment && currentChar + nextChar === '\r\n') {
				insideComment = false;
				i++;
				ret += currentChar;
				ret += nextChar;
				continue;
			} else if (insideComment === singleComment && currentChar === '\n') {
				insideComment = false;
			} else if (!insideComment && currentChar + nextChar === '/*') {
				insideComment = multiComment;
				i++;
				continue;
			} else if (insideComment === multiComment && currentChar + nextChar === '*/') {
				insideComment = false;
				i++;
				continue;
			}

			if (insideComment) {
				continue;
			}

			ret += currentChar;
		}

		return ret;
	}
    
    var algo_params = {};
    var default_params = {};
    function updateParams(server, showConfirmation){
        var jqxhr = $.post( server, algo_params)
                .done(function(data,textStatus,jqXHR) {
                    if(data.substring(0, 6) == "Cannot"){
                        alert("There is no such parameters!");
                        algo_params = default_params;
                    } else {
                        if(showConfirmation){
                            alert("Parameters saved ..");
                        }
                    }
                })
                .fail(function() {
                    alert("Un-expected error occured");
                    algo_params = default_params;
                }); 
    }
    
    RED.nodes.registerType('SDDS',{
        category: 'AlgoPiper',
        color: '#00BFFF',
        defaults: {
            module: {value:""},
            log: {value:""},
            algomanager: {value: "http://manager.algorun.org"},
            docker_image: {value: "algorun/sdds"},
            log_file_path: {value: "http://algopiper.algorun.org"}
        },
        inputs:1,
        outputs: 1,
        icon: "serial.png",
        label: function(){
            return this.module || "SDDS";
        },
        paletteLabel: function(){
            return this.module || "SDDS";
        },
        info: function() {
            var docker_server = '';
            jQuery.ajax({
                url: this.algomanager + '/api/v1/deploy',
                data: {image: this.docker_image, node_id: this.id},
                success: function(result) {
                    if(result["endpoint"]){
                        docker_server = result["endpoint"];
                    }
                  },
                async: false
            });
            if(docker_server === 'not found'){
                return 'info will be available after you click deploy ..';
            }
            if(docker_server !== ''){
                var module_manifest = "unknown";
                jQuery.ajax({
                    url: docker_server + '/v1/manifest',
                    success: function(result) {
                        module_manifest = result["responseText"];
                    },
                    error: function(result) {
                        module_manifest = result["responseText"];
                    },
                    async: false
                });
                if(module_manifest !== 'unknown'){
                    var info_tab = '';
                    module_manifest = JSON.parse(stripJsonComments(module_manifest));
                    info_tab += '#' + module_manifest["algo_name"] + '\n';
                    for(var i = 0;i <module_manifest["algo_authors"].length; i++) {
                        if(i == 0) {
                            info_tab += module_manifest["algo_authors"][i]["name"] + '\n';
                        } else {
                            info_tab += ', ' + module_manifest["algo_authors"][i]["name"] + '\n';
                        }
                    }
                    info_tab += '___\n';
                    info_tab += '# Summary\ntags: ';
                    for(var i = 0;i<module_manifest["algo_keywords"].length; i++){
                        if(i == 0) {
                            info_tab += module_manifest["algo_keywords"][i] + '\n';
                        } else {
                            info_tab += ', ' + module_manifest["algo_keywords"][i] + '\n';
                        }
                    }
                    info_tab += '\nalgo_summary: You can try this algorithm here: [http://sdds.algorun.org](http://sdds.algorun.org)\n';
                    info_tab += '___\n';
                    info_tab += '# Description\n' + module_manifest["algo_description"].replace('<br>', '\n') + '\n';
                    info_tab += '\nmore information: ' + module_manifest["algo_website"] + '\n';
                    info_tab += '___\n';
                    info_tab += '# About AlgoRun\n';
                    info_tab += 'This algorithm is provided to you by AlgoRun. AlgoRun aims at fixing computational science reproducibility by offering an easy way to publish and use algorithms. More information on [http://algorun.org](http://algorun.org)';
                    return info_tab;   
                }
            }
            return 'Cannot load info from node!';
        },
        oneditprepare: function() {
            var node = this;
            $('#wrapper').dialog({
                autoOpen: false,
                title: 'Parameter Configuration'
            });
            $("#params-button").on('click', function(){
                $("#wrapper").dialog( "option", "width", 400 );
                $('#wrapper').dialog('open');
                var docker_server = '';
                jQuery.ajax({
                    url: node.algomanager + '/api/v1/deploy',
                    data: {image: node.docker_image, node_id: node.id},
                    success: function(result) {
                        if(result["endpoint"]){
                            docker_server = result["endpoint"];
                        }
                    },
                    async: false
                });
                if(docker_server === 'not found'){
                    $('#wrapper').html("<p style='text-align: center;'>parameters not available!<br>deploy the node again ..</p>");
                    return false;
                }
                if(docker_server !== ''){
                    var module_manifest = "unknown";
                    jQuery.ajax({
                        url: docker_server + '/v1/manifest',
                        success: function(result) {
                            module_manifest = result["responseText"];
                        },
                        error: function(result) {
                            module_manifest = result["responseText"];
                        },
                        async: false
                    });
                    if(module_manifest !== 'unknown'){
                        module_manifest = JSON.parse(stripJsonComments(module_manifest));
                        default_params = module_manifest["algo_parameters"];
                        if(jQuery.isEmptyObject(algo_params)){
                            algo_params = module_manifest["algo_parameters"];
                            updateParams(docker_server + '/v1/config', false);
                        }
                        // render parameters
                        var params_ui = "<div style='overflow-y: scroll; height: 205px;'><table style='width: 100%; background-color: #F2F2F2;'>";                
                        for (var key in algo_params) {
                            if (algo_params.hasOwnProperty(key)) {
                                var key_id = node.id + '-' + key;
                                var value_id = node.id + '-in-' + key;
                                params_ui += "<tr><td style='width:50%; text-align: center;'><div id='" + key_id +"'>" + key + "</div></td><td style='text-align: center;'><input type='text' style='width:75px; text-align: center; margin-top: 7px;' value='" + algo_params[key]+ "' id='" + value_id +"'></td></tr>";
                            }
                        }
                        params_ui += "</table></div><br>";
                    }
                } else {
                    $('#wrapper').html("<p style='text-align: center;'>cannot connect to algomanager</p>");
                    return false;
                }
                
                // render buttons
                params_ui += "<table style='width:100%;' id ='aaa'><tr>";
                
                params_ui += "<td style='width:50%; text-align: center;'><button id='defaults-button'style='width: 100%;'>reset defaults</button></td>";
                
                params_ui += "<td style='width:50%; text-align: center;'><button id='save-button' style='width: 100%;' >save</button></td>";
                params_ui += "</tr></table>";
                $('#wrapper').html(params_ui);
                $('#save-button').on('click', function(){
                    for (var key in algo_params) {
                        if (algo_params.hasOwnProperty(key)) {
                            var value_id = node.id + '-in-' + key;
                            var new_value = document.getElementById(value_id).value;
                            algo_params[key] = new_value;
                        }
                    }
                    updateParams(docker_server + '/v1/config', true);
                    $(this).closest('.ui-dialog-content').dialog('close'); 
                });
                
                $('#defaults-button').on('click', function(){
                    algo_params = default_params;
                    updateParams(docker_server + '/v1/config', true);
                    $(this).closest('.ui-dialog-content').dialog('close'); 
                });
                return false;
            });
        }
    });
</script>

<script type="text/x-red" data-template-name="SDDS">
    <div class="form-row">
        <label for="node-input-module"><i class="icon-tag"></i> Module</label>
        <input type="text" id="node-input-module" placeholder="Module Name">
    </div>
    <div class="form-row">
        <label for="node-input-log"><i class="icon-tag"></i> Debug</label>
        <select id="node-input-log" style="width:73%">
          <option value="Yes" data-i18n="SDDS.Yes">Yes</option>
          <option value="No" data-i18n="SDDS.No">No</option>
        </select>
    </div>
    <div class="form-row" style="text-align: center;">
        <label for="params"><button type="button" id="params-button">Configure Parameters</button></label>
    </div>
    <div id="wrapper">
    </div>
</script>

<script type="text/x-red" data-help-name="SDDS">
    
</script>